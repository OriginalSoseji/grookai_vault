# Grookai Vault – Overview & Changes (Nov 2, 2025)

This document summarizes what changed on Nov 2, 2025 (America/Denver) and maps the current system based on repo contents and commits.

## Snapshot of Today’s Changes

Commits (since 2025-11-02 00:00 -0700):
- chore(diagnostics): add pricing health script; optional -RefreshNow
- feat(pricing): post-import hook enqueues refresh and runs worker once
- feat(pricing): guardrails (staleness banner), session cache, weekly job cleanup
- feat(dev): Prices as of chip + health service
- feat(pricing): scheduled Edge Function pricing_refresh + security/staleness migration + VS Code task
- chore(db): pristine re-baseline (canonical pricing view + MV + jobs + indexes)
- chore(vscode): add tasks to run price index builder

Changed files grouped by area:
- Flutter UI (`lib/**`)
  - `lib/features/dev/diagnostics/pricing_health_chip.dart` (added/modified): “Prices as of” chip with staleness indicator (2h default), prod-minimal in loading.
  - `lib/features/dev/diagnostics/pricing_smoke_page.dart` (modified): diagnostics/smoke view for pricing.
  - `lib/models/pricing_health.dart` (added): typed model parsed from `pricing_health_v`.
  - `lib/services/pricing_health_service.dart` (added/modified): fetches `pricing_health_v` with a 5‑minute in‑session cache.
  - Risk: UI depends on `pricing_health_v` being readable by anon; confirm grants.
- Supabase Migrations (`supabase/migrations/**`)
  - `20251102_220843_pricing_refresh_security.sql`: hardens job functions to service_role; adds `pricing_health_v` view.
  - `20251102_221736_pricing_ops_hygiene.sql`: weekly prune function via pg_cron; `pricing_alerts_v`.
  - (Present, next day) `20251103_compat_set_counts.sql`: adds `v_set_print_counts` and optional `card_catalog` shim for legacy.
  - (Present, next day) `20251103_card_prints_index_lang_en.sql`: keeps set/lang counts fast.
- Edge Functions (`supabase/functions/**`)
  - `pricing_refresh/` (added): POST-only function enqueues `refresh_latest_card_prices_mv` job and runs `process_jobs(1)`.
  - `import-prices/index.ts` (modified): after inserts, dedup-queues refresh and runs worker once; robust set-code probing.
  - `system_health/index.ts` (existing): SRK-only health rollup; persists run; optional webhook.
- Scripts (`scripts/**`)
  - `scripts/tools/check_pricing_health.ps1` (added): quick health/availability check (SRK if needed).
  - `scripts/tools/create_card_price_indexes.ps1` (added): index helpers; optional MV refresh.
  - `scripts/tools/scan_schema_compat.ps1` (added earlier): scans repo for REST resources; flags missing; suggests compat.
  - `scripts/diagnostics/compute_missing_cards.ps1` (existing): primary/compat/probe fallback chain with SRK optional.
- VS Code (`.vscode/**`)
  - `.vscode/tasks.json` (modified): tasks for guarded release, schema scan, pricing smoke, price index creation, Android build-tools install, and a “enqueue+run now” task for pricing.
- Docs
  - `CHANGELOG.md` (modified): notes for Public Wall MVP, compat view, pricing v2 finalize, health chip.
  - `RELEASE_NOTES.md` (added): brief pricing refresh note.

## High-level System Overview (Today)

- App architecture
  - Flutter app organized by features; services (Supabase REST), models, and view models. Tokens under `lib/ui/tokens/colors.dart` define the electric-blue accent.
  - Diagnostics pages for pricing and health exist under `lib/features/dev/diagnostics/*`.
- Data flow
  - Flutter (anon) → PostgREST views/tables (e.g., `latest_card_prices_v`, `v_set_print_counts`, `public.wall_feed_v`).
  - Edge Functions (Deno) with SRK: imports (`import-prices`, `import-cards`), scheduled `pricing_refresh`, health (`system_health`), status pings.
- Pricing system
  - Ingest: PokémonTCG API → `price_observations` rows, then MV `latest_card_prices_mv` + canonical views.
  - JustTCG/eBay sold engines exist (functions `ext_gateway`, `ebay_sold_engine`, `floor_engine`, etc.).
  - Refresh: new `pricing_refresh` function enqueues and runs `process_jobs` once; job security tightened to SRK only.
  - UI: “Prices as of” chip shows staleness (2h). Service caches response 5 minutes per session.
- Public Wall MVP
  - Migration `20251103_120000_public_wall_mvp.sql` defines `seller_profiles`, `listings`, `listing_photos` with RLS and read-only `public.wall_feed_v` for anon.
  - UI uses `public_wall_v` codepaths in `lib/features/home/home_vm.dart` and feed widgets.
- Diagnostics tooling
  - `scan_schema_compat.ps1` (repo scanner), `compute_missing_cards.ps1` (REST + function probe), `align_migrations.ps1` (helper), and VS Code tasks to run them.
  - Compat layers/fallbacks: `v_set_print_counts`, optional `card_catalog` shim, SRK probe paths in compute script.

## Notes

- Ensure `pricing_health_v` is readable from anon if used in client; otherwise expose a narrow RPC or service proxy.
- The compat set counts and index (dated Nov 3) are present and protect diagnostics and UI that rely on counts by set.

