name: Prod Import-Prices Validate (EDGE â€” bridge-only)

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  GV_ENV: prod
  PROJECT_REF: ycdxbpibncqcchqiihfz
  FUNCS_BASE: https://ycdxbpibncqcchqiihfz.functions.supabase.co

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate import-prices (apikey-only + bridge)
        shell: pwsh
        env:
          FUNCS_BASE: ${{ env.FUNCS_BASE }}
          BRIDGE_IMPORT_TOKEN: ${{ secrets.BRIDGE_IMPORT_TOKEN }}
          PROD_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Host "Missing BRIDGE_IMPORT_TOKEN"; exit 1 }
          $Url = "$env:FUNCS_BASE/import-prices"
          $H = @{ }
          if ($env:PROD_PUBLISHABLE_KEY) { $H['apikey'] = $env:PROD_PUBLISHABLE_KEY }
          $H['x-bridge-token'] = $env:BRIDGE_IMPORT_TOKEN
          $B = @{ ping = 'ci-emit' } | ConvertTo-Json
          try {
            $r = Invoke-WebRequest -Method POST -Uri $Url -Headers $H -Body $B -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $status = [string]$r.StatusCode
            $content = [string]$r.Content
          } catch {
            $status = try { [string]$_.Exception.Response.StatusCode.value__ } catch { '<unknown>' }
            $content = ''
          }
          Write-Output ("URL: " + $Url)
          Write-Output "Method: POST"
          Write-Output ("Status: " + $status)
          Write-Output "GatewayAuth: apikey_only"
          Write-Output ("BridgeTokenHash8: " + (([Text.Encoding]::UTF8.GetBytes($env:BRIDGE_IMPORT_TOKEN) | ForEach-Object { $_.ToString('x2') }) -join '').Substring(0,8))
          $preview = if ($content) { $content.Substring(0,[Math]::Min(300,$content.Length)) } else { '' }
          Write-Output ("Body[0..300]: " + $preview)
          Export "DIAG_B_CODE"  "n/a"
          Export "DIAG_A_CODE"  $status
          Export "FINAL_CODE"   $status
          Export "IMPORT_PRICES_VARIANT" "bridge-edge-apikey-only"
          Export "PUBLISHABLE_HASH8" "<missing>"
          Write-Host ("import-prices Final code: " + $status)

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          Write-Output "Diag echo B code: $env:DIAG_B_CODE"
          Write-Output "Diag echo A code: $env:DIAG_A_CODE"
          Write-Output "import-prices Variant: $env:IMPORT_PRICES_VARIANT"
          Write-Output "import-prices Final code: $env:FINAL_CODE"
          Write-Output "Publishable hash8: $env:PUBLISHABLE_HASH8"
          Write-Output "Bridge hash8: <hidden>"
