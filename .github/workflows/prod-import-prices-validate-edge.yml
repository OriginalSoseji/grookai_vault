name: Prod Import-Prices Validate (EDGE — bridge-only)

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  GV_ENV: prod
  PROJECT_REF: ycdxbpibncqcchqiihfz
  FUNCS_BASE: https://ycdxbpibncqcchqiihfz.functions.supabase.co

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

            - name: Emit diagnostics (apikey-only)
        shell: pwsh
        run: |
          $Url = "https://ycdxbpibncqcchqiihfz.functions.supabase.co/import-prices"
          $H = @{
            apikey           = "${{ secrets.PROD_PUBLISHABLE_KEY }}"
            'x-bridge-token' = "${{ secrets.BRIDGE_IMPORT_TOKEN }}"
          }
          $B = @{ ping = 'ci-emit' } | ConvertTo-Json
          try {
            $r = Invoke-WebRequest -Method POST -Uri $Url -Headers $H -Body $B -ContentType 'application/json' -UseBasicParsing
            $status = [string]$r.StatusCode
            $content = [string]$r.Content
          } catch {
            $status = [string]$_.Exception.Response.StatusCode.value__
            $content = ''
          }

          function Hash8([string]$s) {
            if (-not $s) { return '<none>' }
            $bytes = [Text.Encoding]::UTF8.GetBytes($s)
            $sha = [System.Security.Cryptography.SHA256]::Create().ComputeHash($bytes)
            ($sha | ForEach-Object ToString x2) -join '' | ForEach-Object { $_.Substring(0,8) }
          }

          $body300 = if ($content.Length -gt 300) { $content.Substring(0,300) } else { $content }
          Write-Output "URL: $Url"
          Write-Output "Method: POST"
          Write-Output "Status: $status"
          Write-Output "GatewayAuth: apikey_only"
          Write-Output "BridgeTokenHash8: $(Hash8 '${{ secrets.BRIDGE_IMPORT_TOKEN }}')"
          Write-Output "Body[0..300]: $body300"
name: Prod Import-Prices Validate (EDGE — apikey-only)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Emit diagnostics (apikey-only)
        shell: pwsh
        run: |
          $Url = "https://ycdxbpibncqcchqiihfz.functions.supabase.co/import-prices"
          $H = @{
            apikey           = "${{ secrets.PROD_PUBLISHABLE_KEY }}"
            'x-bridge-token' = "${{ secrets.BRIDGE_IMPORT_TOKEN }}"
          }
          $B = @{ ping = 'ci-emit' } | ConvertTo-Json
          try {
            $r = Invoke-WebRequest -Method POST -Uri $Url -Headers $H -Body $B -ContentType 'application/json' -UseBasicParsing
            $status = [string]$r.StatusCode
            $content = [string]$r.Content
          } catch {
            $status = [string]$_.Exception.Response.StatusCode.value__
            $content = ''
          }

          function Hash8([string]$s) {
            if (-not $s) { return '<none>' }
            $bytes = [Text.Encoding]::UTF8.GetBytes($s)
            $sha = [System.Security.Cryptography.SHA256]::Create().ComputeHash($bytes)
            ($sha | ForEach-Object ToString x2) -join '' | ForEach-Object { $_.Substring(0,8) }
          }

          $body300 = if ($content.Length -gt 300) { $content.Substring(0,300) } else { $content }
          Write-Output "URL: $Url"
          Write-Output "Method: POST"
          Write-Output "Status: $status"
          Write-Output "GatewayAuth: apikey_only"
          Write-Output "BridgeTokenHash8: $(Hash8 '${{ secrets.BRIDGE_IMPORT_TOKEN }}')"
          Write-Output "Body[0..300]: $body300"
