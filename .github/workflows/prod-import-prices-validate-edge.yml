name: Prod Import-Prices Validate (EDGE - bridge-only)

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  PROJECT_REF: ycdxbpibncqcchqiihfz
  FUNCS_BASE: https://ycdxbpibncqcchqiihfz.functions.supabase.co

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Bridge-only probe
        id: probe
        shell: pwsh
        env:
          BRIDGE_IMPORT_TOKEN: ${{ secrets.BRIDGE_IMPORT_TOKEN }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'
          function Hash8([string]$s){ if(-not $s){return '<missing>'}; $sha=[Security.Cryptography.SHA256]::Create(); $h=$sha.ComputeHash([Text.Encoding]::UTF8.GetBytes($s)); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          $u = "https://ycdxbpibncqcchqiihfz.functions.supabase.co/import-prices"
          $H = @{
            'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN
            'content-type' = 'application/json'
          }
          $B = '{"ping":"ci-emit"}'
          try {
            $r = Invoke-WebRequest -Method POST -Uri $u -Headers $H -Body $B -UseBasicParsing -TimeoutSec 30
            $status = [string]$r.StatusCode
            $content = [string]$r.Content
          } catch {
            $status = try { [string]$_.Exception.Response.StatusCode.value__ } catch { '<unknown>' }
            $content = ''
          }

          # Emit six-line summary markers consumed by orchestrator
          Write-Output "DIAG: B/A"
          Write-Output "VARIANT: EDGE-bridge-only"
          Write-Output "FINAL: $status"
          Write-Output "PUBLISHABLE_HASH8: <missing>"
          Write-Output "BRIDGE_HASH8: <hidden>"
          $body100 = if($content.Length -gt 100){ $content.Substring(0,100) } else { $content }
          Write-Output "BODY100: $body100"
          $s = @()
          $s += "DIAG: B/A"
          $s += "VARIANT: EDGE-bridge-only"
          $s += "FINAL: $status"
          $s += "PUBLISHABLE_HASH8: <missing>"
          $s += "BRIDGE_HASH8: <hidden>"
          $s += "BODY100: $body100"
          Set-Content -Path summary.txt -Value ($s -join "`n") -Encoding UTF8
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bridge-validate
          path: summary.txt
