name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (functions domain + real bearer)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.BRIDGE_IMPORT_TOKEN }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co      - name: Diag B (diag-echo with real bearer)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH",'.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          $H = @{ Authorization = "Bearer $($env:SUPABASE_PUBLISHABLE)"; apikey = $env:SUPABASE_PUBLISHABLE }
          try { $r = Invoke-WebRequest -Method GET -Uri $url -Headers $H -UseBasicParsing -TimeoutSec 20; $code = $r.StatusCode }
          catch { $code = if (name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"

      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response) { name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"

      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response.StatusCode.value__ } else { "<unknown>" } }
          Export "DIAG_B_CODE" "$code"
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH",'.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE)"   # REAL bearer
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if (name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"
      - name: Diag B (diag-echo with real bearer)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH",'.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          $H = @{ Authorization = "Bearer $($env:SUPABASE_PUBLISHABLE)"; apikey = $env:SUPABASE_PUBLISHABLE }
          try { $r = Invoke-WebRequest -Method GET -Uri $url -Headers $H -UseBasicParsing -TimeoutSec 20; $code = $r.StatusCode }
          catch { $code = if (name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"

      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response) { name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"

      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response.StatusCode.value__ } else { "<unknown>" } }
          Export "DIAG_B_CODE" "$code"
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response -and name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"
      - name: Diag B (diag-echo with real bearer)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH",'.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          $H = @{ Authorization = "Bearer $($env:SUPABASE_PUBLISHABLE)"; apikey = $env:SUPABASE_PUBLISHABLE }
          try { $r = Invoke-WebRequest -Method GET -Uri $url -Headers $H -UseBasicParsing -TimeoutSec 20; $code = $r.StatusCode }
          catch { $code = if (name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"

      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response) { name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"

      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response.StatusCode.value__ } else { "<unknown>" } }
          Export "DIAG_B_CODE" "$code"
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response.StatusCode.value__) { name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"
      - name: Diag B (diag-echo with real bearer)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH",'.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          $H = @{ Authorization = "Bearer $($env:SUPABASE_PUBLISHABLE)"; apikey = $env:SUPABASE_PUBLISHABLE }
          try { $r = Invoke-WebRequest -Method GET -Uri $url -Headers $H -UseBasicParsing -TimeoutSec 20; $code = $r.StatusCode }
          catch { $code = if (name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"

      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response) { name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"

      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response.StatusCode.value__ } else { "<unknown>" } }
          Export "DIAG_B_CODE" "$code"
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge-real-bearer"      - name: Diag B (diag-echo with real bearer)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH",'.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          $H = @{ Authorization = "Bearer $($env:SUPABASE_PUBLISHABLE)"; apikey = $env:SUPABASE_PUBLISHABLE }
          try { $r = Invoke-WebRequest -Method GET -Uri $url -Headers $H -UseBasicParsing -TimeoutSec 20; $code = $r.StatusCode }
          catch { $code = if (name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (functions domain + real bearer)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.BRIDGE_IMPORT_TOKEN }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co
      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response) { name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"

      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response.StatusCode.value__ } else { "<unknown>" } }
          Export "DIAG_B_CODE" "$code"
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH",'.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE)"   # REAL bearer
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if (name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"
      - name: Diag B (diag-echo with real bearer)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH",'.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          $H = @{ Authorization = "Bearer $($env:SUPABASE_PUBLISHABLE)"; apikey = $env:SUPABASE_PUBLISHABLE }
          try { $r = Invoke-WebRequest -Method GET -Uri $url -Headers $H -UseBasicParsing -TimeoutSec 20; $code = $r.StatusCode }
          catch { $code = if (name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"

      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response) { name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"

      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response.StatusCode.value__ } else { "<unknown>" } }
          Export "DIAG_B_CODE" "$code"
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response -and name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"
      - name: Diag B (diag-echo with real bearer)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH",'.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          $H = @{ Authorization = "Bearer $($env:SUPABASE_PUBLISHABLE)"; apikey = $env:SUPABASE_PUBLISHABLE }
          try { $r = Invoke-WebRequest -Method GET -Uri $url -Headers $H -UseBasicParsing -TimeoutSec 20; $code = $r.StatusCode }
          catch { $code = if (name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"

      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response) { name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"

      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response.StatusCode.value__ } else { "<unknown>" } }
          Export "DIAG_B_CODE" "$code"
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response.StatusCode.value__) { name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"
      - name: Diag B (diag-echo with real bearer)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH",'.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          $H = @{ Authorization = "Bearer $($env:SUPABASE_PUBLISHABLE)"; apikey = $env:SUPABASE_PUBLISHABLE }
          try { $r = Invoke-WebRequest -Method GET -Uri $url -Headers $H -UseBasicParsing -TimeoutSec 20; $code = $r.StatusCode }
          catch { $code = if (name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"

      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response) { name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"

      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response.StatusCode.value__ } else { "<unknown>" } }
          Export "DIAG_B_CODE" "$code"
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge-real-bearer"
      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response) { name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (functions domain + real bearer)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.BRIDGE_IMPORT_TOKEN }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co
      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response.StatusCode.value__ } else { "<unknown>" } }
          Export "DIAG_B_CODE" "$code"
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH",'.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE)"   # REAL bearer
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if (name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"
      - name: Diag B (diag-echo with real bearer)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH",'.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          $H = @{ Authorization = "Bearer $($env:SUPABASE_PUBLISHABLE)"; apikey = $env:SUPABASE_PUBLISHABLE }
          try { $r = Invoke-WebRequest -Method GET -Uri $url -Headers $H -UseBasicParsing -TimeoutSec 20; $code = $r.StatusCode }
          catch { $code = if (name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"

      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response) { name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"

      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response.StatusCode.value__ } else { "<unknown>" } }
          Export "DIAG_B_CODE" "$code"
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response -and name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"
      - name: Diag B (diag-echo with real bearer)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH",'.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          $H = @{ Authorization = "Bearer $($env:SUPABASE_PUBLISHABLE)"; apikey = $env:SUPABASE_PUBLISHABLE }
          try { $r = Invoke-WebRequest -Method GET -Uri $url -Headers $H -UseBasicParsing -TimeoutSec 20; $code = $r.StatusCode }
          catch { $code = if (name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"

      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response) { name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"

      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response.StatusCode.value__ } else { "<unknown>" } }
          Export "DIAG_B_CODE" "$code"
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response.StatusCode.value__) { name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"
      - name: Diag B (diag-echo with real bearer)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH",'.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          $H = @{ Authorization = "Bearer $($env:SUPABASE_PUBLISHABLE)"; apikey = $env:SUPABASE_PUBLISHABLE }
          try { $r = Invoke-WebRequest -Method GET -Uri $url -Headers $H -UseBasicParsing -TimeoutSec 20; $code = $r.StatusCode }
          catch { $code = if (name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"

      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response) { name: Prod Import-Prices Validate (publishable)
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    branches: [ main ]
    paths:
      - "supabase/functions/import-prices/**"

permissions:
  contents: read

env:
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
  BRIDGE_IMPORT_TOKEN: ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: pwsh version
        shell: pwsh
        run: '$PSVersionTable.PSVersion.ToString()'

      - name: Diag echo validator (BΓåÆA)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/diag-echo"
          $body = '{"ping":"ok"}'
          function Try($h,$v){
            try {
              $r = Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$v -> CODE=" + [int]$r.StatusCode + ' BODY=' + [string]$r.Content)
              return [int]$r.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$v -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$v -> CODE=" + $c) }
              return $c
            }
          }
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $cB = Try $hB 'B'
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $cA = Try $hA 'A'
          if (($cB -ge 200 -and $cB -lt 300) -or ($cA -ge 200 -and $cA -lt 300)) {
            Write-Host 'Diag echo reachable with publishable key.'
          } else { Write-Error ("Diag echo failed (B=" + $cB + ', A=' + $cA + ').') }

      - name: Direct BΓåÆAΓåÆcurl validator (no legacy)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          function Mask($s) { if (-not $s) { return "(empty)" } if ($s.Length -le 6) { return "***" } return ($s.Substring(0,3) + "ΓÇª" + $s.Substring($s.Length-3)) }
          function Hash8($s) { if (-not $s) { return "NA" } $sha = [System.Security.Cryptography.SHA256]::Create(); $b=[Text.Encoding]::UTF8.GetBytes($s); $h=$sha.ComputeHash($b); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }

          if (-not $env:SUPABASE_URL) { Write-Error 'Missing SUPABASE_URL' }
          if (-not $env:SUPABASE_PUBLISHABLE_KEY) { Write-Error 'Missing publishable key' }
          if (-not $env:BRIDGE_IMPORT_TOKEN) { Write-Error 'Missing bridge token' }

          Write-Host ('SUPABASE_URL host  : ' + ([uri]$env:SUPABASE_URL).Host)
          Write-Host 'Project ref expect : ycdxbpibncqcchqiihfz'
          Write-Host ('PUB masked/hash8   : ' + (Mask $env:SUPABASE_PUBLISHABLE_KEY) + ' / ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY))
          Write-Host ('BRIDGE masked/hash8: ' + (Mask $env:BRIDGE_IMPORT_TOKEN) + ' / ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN))

          $url  = "$(($env:SUPABASE_URL.TrimEnd('/')))/functions/v1/import-prices"
          $body = '{"ping":"ok"}'
          function Try-Post($headers, $variant) {
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $url -Headers $headers -Body $body -UseBasicParsing -TimeoutSec 20
              Write-Host ("$variant -> CODE=" + [int]$resp.StatusCode)
              return [int]$resp.StatusCode
            } catch {
              $c = try { $_.Exception.Response.StatusCode.value__ } catch { -1 }
              Write-Host ("$variant -> ERROR: " + $_.Exception.Message)
              if ($c -ne -1) { Write-Host ("$variant -> CODE=" + $c) }
              return $c
            }
          }
          # B first
          $hB = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json'; Authorization = ("Bearer " + $env:SUPABASE_PUBLISHABLE_KEY) }
          $codeB = Try-Post $hB 'B'
          if ($codeB -ge 200 -and $codeB -lt 300) { $final='B'; $finalCode=$codeB; goto done }
          # A next
          $hA = @{ apikey = $env:SUPABASE_PUBLISHABLE_KEY; 'x-bridge-token' = $env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
          $codeA = Try-Post $hA 'A'
          if ($codeA -ge 200 -and $codeA -lt 300) { $final='A'; $finalCode=$codeA; goto done }
          # C curl
          $final='C'; $finalCode=-1
          if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
            $out = & curl -sS -i -X POST -H ("apikey: " + $env:SUPABASE_PUBLISHABLE_KEY) -H ("x-bridge-token: " + $env:BRIDGE_IMPORT_TOKEN) -H 'Content-Type: application/json' --max-time 20 --data $body $url
            $first = ($out -split "`n")[0]
            if ($first -match 'HTTP/\S+\s+(\d{3})') { $finalCode = [int]$Matches[1]; Write-Host ("C (curl) -> CODE=" + $finalCode) } else { Write-Host 'C (curl) -> no status parsed' }
          } else { Write-Host 'C (curl) -> curl.exe not available' }
          :done
          $sum = @()
          $sum += '| Field | Value |'
          $sum += '|---|---|'
          $sum += ('| URL host | ' + ([uri]$env:SUPABASE_URL).Host + ' |')
          $sum += '| Project ref (expected) | ycdxbpibncqcchqiihfz |'
          $sum += ('| Publishable hash8 | ' + (Hash8 $env:SUPABASE_PUBLISHABLE_KEY) + ' |')
          $sum += ('| Bridge hash8 | ' + (Hash8 $env:BRIDGE_IMPORT_TOKEN) + ' |')
          $sum += ('| Variant used | ' + $final + ' |')
          $sum += ('| Final code | ' + $finalCode + ' |')
          $sumText = $sum -join "`n"
          $sumText | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          $sum | ForEach-Object { Write-Host $_ }
          if ($finalCode -ge 200 -and $finalCode -lt 300) { exit 0 }
          if ($finalCode -eq 401) { Write-Error '401 from gateway; verify dashboard toggle and secrets.' } else { Write-Error ("Validation failed (Variant=" + $final + ' Code=' + $finalCode + ').') }

# bump: 2025-11-09T23:14:29

      # GV-DIAG-ALWAYS (do not remove)
      - name: Pre-diagnostics (export codes even on failure)
        if: always()
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"

          function Hash8([string]$s){ if([string]::IsNullOrWhiteSpace($s)){return "<missing>"} ($d=[Security.Cryptography.SHA256]::Create()).ComputeHash([Text.Encoding]::UTF8.GetBytes($s))|%{$_.ToString('x2')} -join '' | % { $_.Substring(0,8) } }
          function Export([string]$k,[string]$v){ "$($k)=$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }

          # B: GET root (publishable headers)
          $diagB = "<unknown>"
          try {
            $h = @{ Authorization = "Bearer $env:SUPABASE_PUBLISHABLE"; apikey = $env:SUPABASE_PUBLISHABLE }
            $resp = Invoke-WebRequest -Method GET -Uri "$($env:SUPABASE_URL)" -Headers $h -UseBasicParsing -TimeoutSec 15
            $diagB = $resp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagB = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_B_CODE" "$diagB"

          # A: import-prices ping (verify_jwt=false)
          $diagA = "<unknown>"
          try {
            $eh = @{ "x-bridge-token" = "$env:BRIDGE_IMPORT_TOKEN" }
            $eurl = "$($env:SUPABASE_URL.TrimEnd('/'))/functions/v1/import-prices"
            $ebody = @{ ping = "diag" } | ConvertTo-Json
            $eresp = Invoke-WebRequest -Method POST -Uri $eurl -Headers $eh -Body $ebody -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
            $diagA = $eresp.StatusCode
          } catch {
            if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $diagA = $_.Exception.Response.StatusCode.value__ }
          }
          Export "DIAG_A_CODE" "$diagA"
          Export "FINAL_CODE"    "$diagA"
          Export "IMPORT_PRICES_VARIANT" "publishable"
      - name: Validate import-prices (Edge via functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:              ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          BRIDGE_IMPORT_TOKEN:       ${{ secrets.PROD_BRIDGE_IMPORT_TOKEN_IMPORT_PRICES }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/import-prices"
          $body  = @{ ping = "diag" } | ConvertTo-Json
          $H = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
          $H["x-bridge-token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["X-Bridge-Token"] = $env:BRIDGE_IMPORT_TOKEN
          $H["Authorization"]  = "Bearer $($env:SUPABASE_PUBLISHABLE_KEY)"
          $H["apikey"]         = $env:SUPABASE_PUBLISHABLE_KEY
          try {
            $r = Invoke-WebRequest -Method POST -Uri $url -Headers $H -Body $body -ContentType 'application/json' -UseBasicParsing -TimeoutSec 30
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge"

      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response.StatusCode.value__ } else { "<unknown>" } }
          Export "DIAG_B_CODE" "$code"
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_A_CODE" "$code"
          Export "FINAL_CODE"  "$code"
          Export "IMPORT_PRICES_VARIANT" "publishable-edge-real-bearer"
      - name: Diag B (diag-echo on functions.supabase.co)
        if: always()
        shell: pwsh
        env:
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Continue"
          function Export([string]$k,[string]$v){ "`$($k)=`$($v)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append }
          $FUNCS = $env:SUPABASE_URL -replace '\.supabase\.co$','.functions.supabase.co'
          $url   = "$FUNCS/diag-echo"
          try {
            $r = Invoke-WebRequest -Method GET -Uri $url -UseBasicParsing -TimeoutSec 15
            $code = $r.StatusCode
          } catch {
            $code = if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__) { $_.Exception.Response.StatusCode.value__ } else { "<unknown>" }
          }
          Export "DIAG_B_CODE" "$code"

      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH".Exception.Response.StatusCode.value__ } else { "<unknown>" } }
          Export "DIAG_B_CODE" "$code"
      - name: Emit diagnostics (always)
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          function Hash8([string]$s) {
            if ([string]::IsNullOrWhiteSpace($s)) { return "<missing>" }
            $b = [Text.Encoding]::UTF8.GetBytes($s)
            $h = [Security.Cryptography.SHA256]::Create().ComputeHash($b)
            (-join ($h | ForEach-Object { $_.ToString("x2") })).Substring(0,8)
          }
          $diagB = $env:DIAG_B_CODE; if (-not $diagB) { $diagB = "<unknown>" }
          $diagA = $env:DIAG_A_CODE; if (-not $diagA) { $diagA = "<unknown>" }
          $variant = $env:IMPORT_PRICES_VARIANT; if (-not $variant) { $variant = "<unknown>" }
          $final = $env:FINAL_CODE; if (-not $final) { $final = "<unknown>" }
          $pubH = Hash8 $env:SUPABASE_PUBLISHABLE_KEY
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:PROD_PUBLISHABLE_KEY }
          if ($pubH -eq "<missing>") { $pubH = Hash8 $env:SUPABASE_ANON_KEY }
          $brH = Hash8 $env:BRIDGE_IMPORT_TOKEN
          if ($brH -eq "<missing>") { $brH = Hash8 $env:IMPORT_PRICES_BRIDGE_TOKEN }
          Write-Host "Diag echo B code: $diagB"
          Write-Host "Diag echo A code: $diagA"
          Write-Host "import-prices Variant: $variant"
          Write-Host "import-prices Final code: $final"
          Write-Host "Publishable hash8: $pubH"
          Write-Host "Bridge hash8: $brH"