name: Prod Edge Probe (read-only)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'
  push:
    branches: [ main ]
    paths:
      - 'supabase/functions/**'

permissions:
  contents: read

jobs:
  probe:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    env:
      # Map secrets to ALL names the scripts might read
      PROJECT_URL: ${{ secrets.PROD_SUPABASE_URL }}
      SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
      ANON_KEY: ${{ secrets.PROD_ANON_KEY }}
      SUPABASE_ANON_KEY: ${{ secrets.PROD_ANON_KEY }}
      SERVICE_ROLE_KEY: ${{ secrets.PROD_SERVICE_ROLE_KEY }}
      GV_ENV: prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Mask secrets
        run: |
          echo "::add-mask::$env:ANON_KEY"
          echo "::add-mask::$env:SUPABASE_ANON_KEY"
          echo "::add-mask::$env:SERVICE_ROLE_KEY"

      - name: Sanity echo (sanitized)
        run: |
          Write-Host "PROJECT_URL set: $([bool]$env:PROJECT_URL)"
          Write-Host "SUPABASE_URL set: $([bool]$env:SUPABASE_URL)"
          Write-Host "ANON_KEY present: $([bool]$env:ANON_KEY)"
          Write-Host "SUPABASE_ANON_KEY present: $([bool]$env:SUPABASE_ANON_KEY)"

      - name: Run PROD edge test
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          powershell -NoProfile -ExecutionPolicy Bypass -File .\.codex\test_edges_prod.ps1

      - name: Summarize last report
        id: show
        run: |
          $dir = Get-ChildItem .\reports -Directory -Filter 'edge_test_*' | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $dir) { throw "No report folder created by test_edges_prod.ps1" }
          $edge = Join-Path $dir.FullName 'edge_results.txt'
          $sum  = Join-Path $dir.FullName 'SUMMARY.md'
          echo "## PROD Edge Probe"              >> $env:GITHUB_STEP_SUMMARY
          echo "Report: $($dir.FullName)"        >> $env:GITHUB_STEP_SUMMARY
          Get-Content $edge | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
          ""                                     | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
          Get-Content $sum  | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
          "summary_path=$sum" | Out-File -Append -FilePath $env:GITHUB_OUTPUT -Encoding utf8

      # Optional: make the job fail if any endpoint != 200
      - name: Gate on results
        run: |
          $sum = Get-Content "${{ steps.show.outputs.summary_path }}" -Raw
          $ok1 = $sum -match '\|\simport-prices\s\|\sPOST\s\|\sservice-role\s\|\s200\s\|\sTrue'
          $ok2 = $sum -match '\|\scheck-sets\s\|\sPOST\s\|\sservice-role\s\|\s200\s\|\sTrue'
          $ok3 = $sum -match '\|\swall_feed\s\|\sGET\s\|\sanon\s\|\s200\s\|\sTrue'
          if (-not ($ok1 -and $ok2 -and $ok3)) {
            Write-Error "Edge probe failed. One or more endpoints not 200."
          }
