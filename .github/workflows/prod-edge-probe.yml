jobs:
  probe:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    env:
      # New names (preferred)
      PROJECT_URL: ${{ secrets.PROD_SUPABASE_URL }}
      SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
      SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
      SUPABASE_SECRET_KEY:      ${{ secrets.PROD_SECRET_KEY }}
      GV_ENV: prod
      # Legacy aliases to keep old scripts working
      ANON_KEY:             ${{ secrets.PROD_PUBLISHABLE_KEY }}
      SUPABASE_ANON_KEY:    ${{ secrets.PROD_PUBLISHABLE_KEY }}
      SERVICE_ROLE_KEY:     ${{ secrets.PROD_SECRET_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Diagnostics â€” PS version & env presence
        run: |
          $ErrorActionPreference = 'Stop'
          Write-Host "PSVersion:"; $PSVersionTable
          $required = @(
            'PROJECT_URL','SUPABASE_URL',
            'SUPABASE_PUBLISHABLE_KEY','SUPABASE_SECRET_KEY','GV_ENV'
          )
          $missing = $required | Where-Object { -not $env:$_ -or [string]::IsNullOrWhiteSpace($env:$_) }
          if ($missing.Count -gt 0) {
            Write-Error ("Missing required env vars: {0}" -f ($missing -join ', '))
          } else {
            Write-Host "All required env vars are present."
          }

      - name: Run PROD edge test (pwsh, loud)
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
          Set-StrictMode -Version Latest

          $script = ".\.codex\test_edges_prod.ps1"
          if (-not (Test-Path $script)) { throw "Missing $script" }

          $log = Join-Path $env:RUNNER_TEMP "probe.log"
          try {
            & $script *>&1 | Tee-Object -FilePath $log
            $code = $LASTEXITCODE
            if ($code -ne 0) { throw "Probe script exit code $code" }
          } catch {
            Write-Host "---- probe.log (captured output) ----"
            if (Test-Path $log) { Get-Content $log -Raw | Write-Host }
            Write-Error $_
            exit 1
          }
