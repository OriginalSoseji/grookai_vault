name: Prod Edge Probe (read-only)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'
  push:
    branches: [ main ]
    paths:
      - 'supabase/functions/**'
      - '.codex/test_edges_prod.ps1'
      - '.github/workflows/prod-edge-probe.yml'

permissions:
  contents: read

jobs:
  probe:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    env:
      PROJECT_URL: ${{ secrets.PROD_SUPABASE_URL }}
      SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
      SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
      SUPABASE_SECRET_KEY: ${{ secrets.PROD_SECRET_KEY }}
      GV_ENV: prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sanity echo (presence only)
        run: |
          Write-Host "PROJECT_URL set: $([bool]$env:PROJECT_URL)"
          Write-Host "SUPABASE_URL set: $([bool]$env:SUPABASE_URL)"
          Write-Host "PUBLISHABLE present: $([bool]$env:SUPABASE_PUBLISHABLE_KEY)"
          Write-Host "SECRET present: $([bool]$env:SUPABASE_SECRET_KEY)"

          - name: Diagnostics: wall_feed
      shell: pwsh
      env:
        BASE: https://${{ env.SUPABASE_HOST }}
        PUB:  ${{ env.SUPABASE_PUBLISHABLE_KEY }}
      run: |
        Write-Host "URL: $env:BASE/functions/v1/wall_feed"
        Write-Host "Auth (Bearer): PUBLISHABLE"
        try {
          $r = Invoke-WebRequest -UseBasicParsing -Method GET "$env:BASE/functions/v1/wall_feed" -Headers @{ "apikey"=$env:PUB; "Authorization"="Bearer $env:PUB" }
          Write-Host "Status:" $r.StatusCode
          $body = $r.Content
        } catch {
          if ($_.Exception.Response) {
            Write-Host "Status:" ([int]$_.Exception.Response.StatusCode.Value__)
            $sr = New-Object System.IO.StreamReader ($_.Exception.Response.GetResponseStream())
            $body = $sr.ReadToEnd()
          } else { Write-Host "ERROR:" $_.Exception.Message }
        }
        if ($body) { Write-Host "Body[0..300]:" ($body.Substring(0,[Math]::Min(300,$body.Length))) }    - name: Install Supabase CLI
      uses: supabase/setup-cli@v1

    - name: List functions (runner view)
      shell: pwsh
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      run: |
        supabase functions list --project-ref ycdxbpibncqcchqiihfz- name: Run PS7-safe edge probe
        continue-on-error: true
        run: |
          $ErrorActionPreference='Stop'
          $ProgressPreference='SilentlyContinue'
          Set-StrictMode -Version Latest
          . ./.codex/test_edges_prod.ps1

          - name: Diagnose wall_feed (anon)
      shell: pwsh
      env:
        SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.PROD_ANON_KEY }}
      run: |
        $url = "$env:SUPABASE_URL/functions/v1/wall_feed"
        $h = @{ "apikey"=$env:SUPABASE_ANON_KEY; "Authorization"="Bearer $($env:SUPABASE_ANON_KEY)" }
        try {
          $r = Invoke-WebRequest -Uri $url -Headers $h -Method GET -UseBasicParsing -TimeoutSec 30
          $status = $r.StatusCode; $body = $r.Content
        } catch {
          if ($_.Exception.Response) {
            $status = [int]$_.Exception.Response.StatusCode.Value__
            $sr = New-Object System.IO.StreamReader ($_.Exception.Response.GetResponseStream())
            $body = $sr.ReadToEnd()
          } else { $status = 'ERR'; $body = $_.Exception.Message }
        }
        $snippet = if ($body) { $body.Substring(0,[Math]::Min(300,$body.Length)) } else { '' }
        "URL: $url"
        "STATUS: $status"
        "BODY[0..300]: $snippet"- name: Summarize last report
        if: always()
        id: show
        run: |
          $dir = Get-ChildItem .\reports -Directory -Filter 'edge_test_*' | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $dir) {
            $stamp = Get-Date -Format "yyyyMMdd_HHmmss"
            $dir = New-Item -ItemType Directory -Force -Path ".\reports\edge_test_$stamp"
            "NAME, METHOD, AUTH, CODE, OK" | Out-File (Join-Path $dir "edge_results.txt") -Encoding utf8
            "Probe produced no report folder; created placeholder." | Out-File (Join-Path $dir "SUMMARY.md") -Encoding utf8
          }
          $edge = Join-Path $dir.FullName 'edge_results.txt'
          $sum  = Join-Path $dir.FullName 'SUMMARY.md'
          "## PROD Edge Probe"              | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
          "Report: $($dir.FullName)"        | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
          if (Test-Path $edge) { Get-Content $edge | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 }
          ""                                | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
          if (Test-Path $sum)  { Get-Content $sum  | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 }
          "summary_path=$sum" | Out-File -Append -FilePath $env:GITHUB_OUTPUT -Encoding utf8

      - name: Upload probe artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: prod-edge-probe
          path: |
            reports/**/edge_results.txt
            reports/**/SUMMARY.md
          if-no-files-found: warn
      - name: Preflight â€” check SUPABASE_ACCESS_TOKEN
        run: echo "SUPABASE_ACCESS_TOKEN present? ${{ secrets.SUPABASE_ACCESS_TOKEN != '' }}"
        continue-on-error: true

      - name: List functions (runner view)
        if: ${{ secrets.SUPABASE_ACCESS_TOKEN != '' }}
        uses: supabase/setup-cli@v1
      - name: List functions (runner view)
        if: ${{ secrets.SUPABASE_ACCESS_TOKEN != '' }}
        shell: pwsh
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          supabase functions list --project-ref ycdxbpibncqcchqiihfz

      - name: Diagnose wall_feed (anon)
        shell: pwsh
        continue-on-error: true
        env:
          SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.PROD_ANON_KEY }}
        run: |
          $url = "$env:SUPABASE_URL/functions/v1/wall_feed"
          $h = @{ apikey=$env:SUPABASE_ANON_KEY; Authorization="Bearer $($env:PROD_ANON_KEY)" }
          try {
            $r = Invoke-WebRequest -Uri $url -Headers $h -Method GET -UseBasicParsing -TimeoutSec 30
            $status = $r.StatusCode; $body = $r.Content
          } catch {
            $status = name: Prod Edge Probe (read-only)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'
  push:
    branches: [ main ]
    paths:
      - 'supabase/functions/**'
      - '.codex/test_edges_prod.ps1'
      - '.github/workflows/prod-edge-probe.yml'

permissions:
  contents: read

jobs:
  probe:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    env:
      PROJECT_URL: ${{ secrets.PROD_SUPABASE_URL }}
      SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
      SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
      SUPABASE_SECRET_KEY: ${{ secrets.PROD_SECRET_KEY }}
      GV_ENV: prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sanity echo (presence only)
        run: |
          Write-Host "PROJECT_URL set: $([bool]$env:PROJECT_URL)"
          Write-Host "SUPABASE_URL set: $([bool]$env:SUPABASE_URL)"
          Write-Host "PUBLISHABLE present: $([bool]$env:SUPABASE_PUBLISHABLE_KEY)"
          Write-Host "SECRET present: $([bool]$env:SUPABASE_SECRET_KEY)"

          - name: Diagnostics: wall_feed
      shell: pwsh
      env:
        BASE: https://${{ env.SUPABASE_HOST }}
        PUB:  ${{ env.SUPABASE_PUBLISHABLE_KEY }}
      run: |
        Write-Host "URL: $env:BASE/functions/v1/wall_feed"
        Write-Host "Auth (Bearer): PUBLISHABLE"
        try {
          $r = Invoke-WebRequest -UseBasicParsing -Method GET "$env:BASE/functions/v1/wall_feed" -Headers @{ "apikey"=$env:PUB; "Authorization"="Bearer $env:PUB" }
          Write-Host "Status:" $r.StatusCode
          $body = $r.Content
        } catch {
          if ($_.Exception.Response) {
            Write-Host "Status:" ([int]$_.Exception.Response.StatusCode.Value__)
            $sr = New-Object System.IO.StreamReader ($_.Exception.Response.GetResponseStream())
            $body = $sr.ReadToEnd()
          } else { Write-Host "ERROR:" $_.Exception.Message }
        }
        if ($body) { Write-Host "Body[0..300]:" ($body.Substring(0,[Math]::Min(300,$body.Length))) }    - name: Install Supabase CLI
      uses: supabase/setup-cli@v1

    - name: List functions (runner view)
      shell: pwsh
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      run: |
        supabase functions list --project-ref ycdxbpibncqcchqiihfz- name: Run PS7-safe edge probe
        continue-on-error: true
        run: |
          $ErrorActionPreference='Stop'
          $ProgressPreference='SilentlyContinue'
          Set-StrictMode -Version Latest
          . ./.codex/test_edges_prod.ps1

          - name: Diagnose wall_feed (anon)
      shell: pwsh
      env:
        SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.PROD_ANON_KEY }}
      run: |
        $url = "$env:SUPABASE_URL/functions/v1/wall_feed"
        $h = @{ "apikey"=$env:SUPABASE_ANON_KEY; "Authorization"="Bearer $($env:SUPABASE_ANON_KEY)" }
        try {
          $r = Invoke-WebRequest -Uri $url -Headers $h -Method GET -UseBasicParsing -TimeoutSec 30
          $status = $r.StatusCode; $body = $r.Content
        } catch {
          if ($_.Exception.Response) {
            $status = [int]$_.Exception.Response.StatusCode.Value__
            $sr = New-Object System.IO.StreamReader ($_.Exception.Response.GetResponseStream())
            $body = $sr.ReadToEnd()
          } else { $status = 'ERR'; $body = $_.Exception.Message }
        }
        $snippet = if ($body) { $body.Substring(0,[Math]::Min(300,$body.Length)) } else { '' }
        "URL: $url"
        "STATUS: $status"
        "BODY[0..300]: $snippet"- name: Summarize last report
        if: always()
        id: show
        run: |
          $dir = Get-ChildItem .\reports -Directory -Filter 'edge_test_*' | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $dir) {
            $stamp = Get-Date -Format "yyyyMMdd_HHmmss"
            $dir = New-Item -ItemType Directory -Force -Path ".\reports\edge_test_$stamp"
            "NAME, METHOD, AUTH, CODE, OK" | Out-File (Join-Path $dir "edge_results.txt") -Encoding utf8
            "Probe produced no report folder; created placeholder." | Out-File (Join-Path $dir "SUMMARY.md") -Encoding utf8
          }
          $edge = Join-Path $dir.FullName 'edge_results.txt'
          $sum  = Join-Path $dir.FullName 'SUMMARY.md'
          "## PROD Edge Probe"              | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
          "Report: $($dir.FullName)"        | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
          if (Test-Path $edge) { Get-Content $edge | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 }
          ""                                | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
          if (Test-Path $sum)  { Get-Content $sum  | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 }
          "summary_path=$sum" | Out-File -Append -FilePath $env:GITHUB_OUTPUT -Encoding utf8

      - name: Upload probe artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: prod-edge-probe
          path: |
            reports/**/edge_results.txt
            reports/**/SUMMARY.md
          if-no-files-found: warn

      - name: Gate on results (require 200/True for all)
        run: |
          $sum = Get-Content "${{ steps.show.outputs.summary_path }}" -Raw
          $ok1 = $sum -match '\|\swall_feed\s\|\sGET\s\|\sanon\s\|\s200\s\|\sTrue'
          $ok2 = $sum -match '\|\scheck-sets\s\|\sPOST\s\|\ssecret\s\|\s200\s\|\sTrue'
          $ok3 = $sum -match '\|\simport-prices\s\|\sPOST\s\|\ssecret\s\|\s200\s\|\sTrue'
          if (-not ($ok1 -and $ok2 -and $ok3)) { Write-Error "Edge probe failed. One or more endpoints not 200." }




.Exception.Response.StatusCode.value__
            $sr = New-Object IO.StreamReader(name: Prod Edge Probe (read-only)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'
  push:
    branches: [ main ]
    paths:
      - 'supabase/functions/**'
      - '.codex/test_edges_prod.ps1'
      - '.github/workflows/prod-edge-probe.yml'

permissions:
  contents: read

jobs:
  probe:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    env:
      PROJECT_URL: ${{ secrets.PROD_SUPABASE_URL }}
      SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
      SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
      SUPABASE_SECRET_KEY: ${{ secrets.PROD_SECRET_KEY }}
      GV_ENV: prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sanity echo (presence only)
        run: |
          Write-Host "PROJECT_URL set: $([bool]$env:PROJECT_URL)"
          Write-Host "SUPABASE_URL set: $([bool]$env:SUPABASE_URL)"
          Write-Host "PUBLISHABLE present: $([bool]$env:SUPABASE_PUBLISHABLE_KEY)"
          Write-Host "SECRET present: $([bool]$env:SUPABASE_SECRET_KEY)"

          - name: Diagnostics: wall_feed
      shell: pwsh
      env:
        BASE: https://${{ env.SUPABASE_HOST }}
        PUB:  ${{ env.SUPABASE_PUBLISHABLE_KEY }}
      run: |
        Write-Host "URL: $env:BASE/functions/v1/wall_feed"
        Write-Host "Auth (Bearer): PUBLISHABLE"
        try {
          $r = Invoke-WebRequest -UseBasicParsing -Method GET "$env:BASE/functions/v1/wall_feed" -Headers @{ "apikey"=$env:PUB; "Authorization"="Bearer $env:PUB" }
          Write-Host "Status:" $r.StatusCode
          $body = $r.Content
        } catch {
          if ($_.Exception.Response) {
            Write-Host "Status:" ([int]$_.Exception.Response.StatusCode.Value__)
            $sr = New-Object System.IO.StreamReader ($_.Exception.Response.GetResponseStream())
            $body = $sr.ReadToEnd()
          } else { Write-Host "ERROR:" $_.Exception.Message }
        }
        if ($body) { Write-Host "Body[0..300]:" ($body.Substring(0,[Math]::Min(300,$body.Length))) }    - name: Install Supabase CLI
      uses: supabase/setup-cli@v1

    - name: List functions (runner view)
      shell: pwsh
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      run: |
        supabase functions list --project-ref ycdxbpibncqcchqiihfz- name: Run PS7-safe edge probe
        continue-on-error: true
        run: |
          $ErrorActionPreference='Stop'
          $ProgressPreference='SilentlyContinue'
          Set-StrictMode -Version Latest
          . ./.codex/test_edges_prod.ps1

          - name: Diagnose wall_feed (anon)
      shell: pwsh
      env:
        SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.PROD_ANON_KEY }}
      run: |
        $url = "$env:SUPABASE_URL/functions/v1/wall_feed"
        $h = @{ "apikey"=$env:SUPABASE_ANON_KEY; "Authorization"="Bearer $($env:SUPABASE_ANON_KEY)" }
        try {
          $r = Invoke-WebRequest -Uri $url -Headers $h -Method GET -UseBasicParsing -TimeoutSec 30
          $status = $r.StatusCode; $body = $r.Content
        } catch {
          if ($_.Exception.Response) {
            $status = [int]$_.Exception.Response.StatusCode.Value__
            $sr = New-Object System.IO.StreamReader ($_.Exception.Response.GetResponseStream())
            $body = $sr.ReadToEnd()
          } else { $status = 'ERR'; $body = $_.Exception.Message }
        }
        $snippet = if ($body) { $body.Substring(0,[Math]::Min(300,$body.Length)) } else { '' }
        "URL: $url"
        "STATUS: $status"
        "BODY[0..300]: $snippet"- name: Summarize last report
        if: always()
        id: show
        run: |
          $dir = Get-ChildItem .\reports -Directory -Filter 'edge_test_*' | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $dir) {
            $stamp = Get-Date -Format "yyyyMMdd_HHmmss"
            $dir = New-Item -ItemType Directory -Force -Path ".\reports\edge_test_$stamp"
            "NAME, METHOD, AUTH, CODE, OK" | Out-File (Join-Path $dir "edge_results.txt") -Encoding utf8
            "Probe produced no report folder; created placeholder." | Out-File (Join-Path $dir "SUMMARY.md") -Encoding utf8
          }
          $edge = Join-Path $dir.FullName 'edge_results.txt'
          $sum  = Join-Path $dir.FullName 'SUMMARY.md'
          "## PROD Edge Probe"              | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
          "Report: $($dir.FullName)"        | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
          if (Test-Path $edge) { Get-Content $edge | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 }
          ""                                | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
          if (Test-Path $sum)  { Get-Content $sum  | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 }
          "summary_path=$sum" | Out-File -Append -FilePath $env:GITHUB_OUTPUT -Encoding utf8

      - name: Upload probe artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: prod-edge-probe
          path: |
            reports/**/edge_results.txt
            reports/**/SUMMARY.md
          if-no-files-found: warn

      - name: Gate on results (require 200/True for all)
        run: |
          $sum = Get-Content "${{ steps.show.outputs.summary_path }}" -Raw
          $ok1 = $sum -match '\|\swall_feed\s\|\sGET\s\|\sanon\s\|\s200\s\|\sTrue'
          $ok2 = $sum -match '\|\scheck-sets\s\|\sPOST\s\|\ssecret\s\|\s200\s\|\sTrue'
          $ok3 = $sum -match '\|\simport-prices\s\|\sPOST\s\|\ssecret\s\|\s200\s\|\sTrue'
          if (-not ($ok1 -and $ok2 -and $ok3)) { Write-Error "Edge probe failed. One or more endpoints not 200." }




.Exception.Response.GetResponseStream())
            $body = $sr.ReadToEnd()
          }
          $snippet = if ($body.Length -gt 300) { $body.Substring(0,300) } else { $body }
          "URL: $url" | Out-File -Encoding UTF8 SUMMARY.md
          "STATUS: $status" | Out-File -Append -Encoding UTF8 SUMMARY.md
          "BODY[0..300]: $snippet" | Out-File -Append -Encoding UTF8 SUMMARY.md

      - name: Upload probe summary
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: prod-edge-probe
          path: SUMMARY.md
          if-no-files-found: warn
      - name: Gate on results (require 200/True for all)
        run: |
          $sum = Get-Content "${{ steps.show.outputs.summary_path }}" -Raw
          $ok1 = $sum -match '\|\swall_feed\s\|\sGET\s\|\sanon\s\|\s200\s\|\sTrue'
          $ok2 = $sum -match '\|\scheck-sets\s\|\sPOST\s\|\ssecret\s\|\s200\s\|\sTrue'
          $ok3 = $sum -match '\|\simport-prices\s\|\sPOST\s\|\ssecret\s\|\s200\s\|\sTrue'
          if (-not ($ok1 -and $ok2 -and $ok3)) { Write-Error "Edge probe failed. One or more endpoints not 200." }





