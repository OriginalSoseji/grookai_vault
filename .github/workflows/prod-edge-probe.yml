jobs:
  probe:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    env:
      # Primary (new) names
      PROJECT_URL: ${{ secrets.PROD_SUPABASE_URL }}
      SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
      SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}
      SUPABASE_SECRET_KEY:      ${{ secrets.PROD_SECRET_KEY }}
      GV_ENV: prod
      # Legacy aliases (kept for backward-compat in scripts)
      ANON_KEY:             ${{ secrets.PROD_PUBLISHABLE_KEY }}
      SUPABASE_ANON_KEY:    ${{ secrets.PROD_PUBLISHABLE_KEY }}
      SERVICE_ROLE_KEY:     ${{ secrets.PROD_SECRET_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Diagnostics â€” PS version & env presence
        run: |
          $ErrorActionPreference = 'Stop'
          Write-Host "PSVersion:"; $PSVersionTable
          $required = @(
            'PROJECT_URL','SUPABASE_URL',
            'SUPABASE_PUBLISHABLE_KEY','SUPABASE_SECRET_KEY','GV_ENV'
          )
          $missing = $required | Where-Object { -not $env:$_ -or [string]::IsNullOrWhiteSpace($env:$_) }
          if ($missing.Count -gt 0) {
            Write-Error ("Missing required env vars: {0}" -f ($missing -join ', '))
          } else {
            Write-Host "All required env vars are present."
          }

      - name: Run PROD edge test (pwsh)
        run: |
          $ErrorActionPreference = 'Stop'
          if (-not (Test-Path '.\.codex\test_edges_prod.ps1')) {
            throw "Missing .\.codex\test_edges_prod.ps1"
          }
          # Execute directly in pwsh (no nested 'powershell' call)
          & .\.codex\test_edges_prod.ps1
