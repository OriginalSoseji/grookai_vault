name: Staging Ensure + Deploy + Smoke

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

# Required repo secrets:
# - SUPABASE_ACCESS_TOKEN
# - SUPABASE_PROJECT_REF_STAGING
# - STAGING_DB_URL           (postgres://...)
# - STAGING_DB_URL_SHADOW    (postgres://... shadow DB)
# - STAGING_REST_URL         (https://<ref>.supabase.co)
# - STAGING_PUBLISHABLE_KEY

jobs:
  staging:
    runs-on: ubuntu-latest
    env:
      POKEMON_TCG_API_KEY: ${{ secrets.POKEMON_TCG_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (for Supabase CLI)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Supabase CLI
        run: npm i -g supabase

      - name: Supabase CLI version
        run: supabase --version

      - name: Ensure-ready on SHADOW (reset + seed)
        env:
          STAGING_DB_URL_SHADOW: ${{ secrets.STAGING_DB_URL_SHADOW }}
        run: |
          supabase db reset --db-url "$STAGING_DB_URL_SHADOW"
          psql "$STAGING_DB_URL_SHADOW" -f supabase/seed/dev/seed_basic.sql || true

      - name: Push migrations to STAGING
        env:
          STAGING_DB_URL: ${{ secrets.STAGING_DB_URL }}
        run: supabase db push --db-url "$STAGING_DB_URL"

      - name: Deploy functions (wall_feed)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF_STAGING: ${{ secrets.SUPABASE_PROJECT_REF_STAGING }}
        run: supabase functions deploy wall_feed --project-ref "$SUPABASE_PROJECT_REF_STAGING" --no-verify-jwt

      - name: REST smoke on STAGING
        env:
          STAGING_REST_URL: ${{ secrets.STAGING_REST_URL }}
          STAGING_PUBLISHABLE_KEY: ${{ secrets.STAGING_PUBLISHABLE_KEY }}
        run: |
          set -e
          curl -sSf -H "apikey: $STAGING_PUBLISHABLE_KEY" "$STAGING_REST_URL/rest/v1/listings?select=id&limit=1" > /dev/null
          curl -sSf -H "apikey: $STAGING_PUBLISHABLE_KEY" "$STAGING_REST_URL/rest/v1/wall_feed_view?select=listing_id&limit=1" > /dev/null
