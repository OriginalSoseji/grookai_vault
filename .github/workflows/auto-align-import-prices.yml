name: Auto-Align Import-Prices (bridge-only)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

permissions:
  contents: read

env:
  PROJECT_REF: ycdxbpibncqcchqiihfz
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}

jobs:
  align-and-validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Guard required secrets
        shell: pwsh
        run: |
          if (-not "${{ secrets.SUPABASE_ACCESS_TOKEN }}") { throw "Missing SUPABASE_ACCESS_TOKEN" }
          if (-not "${{ secrets.PROD_PUBLISHABLE_KEY }}") { throw "Missing PROD_PUBLISHABLE_KEY" }
          if (-not "${{ secrets.BRIDGE_IMPORT_TOKEN }}") { throw "Missing BRIDGE_IMPORT_TOKEN" }

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1

      - name: Ensure verify_jwt=false (idempotent)
        shell: pwsh
        run: |
          $p = "supabase/functions/import-prices/config.toml"
          if (-not (Test-Path $p)) { New-Item -ItemType Directory -Force -Path (Split-Path $p) | Out-Null; Set-Content $p "verify_jwt = false" -NoNewline; git add $p; git commit -m "ci(auto): add config.toml verify_jwt=false" || $true; git push || $true }
          else {
            $txt = Get-Content $p -Raw
            if ($txt -notmatch '(?m)^\s*verify_jwt\s*=\s*false\s*$') {
              ($txt -replace '(?m)^\s*verify_jwt\s*=\s*\w+\s*$', 'verify_jwt = false') | Set-Content $p
              git add $p; git commit -m "ci(auto): enforce verify_jwt=false" || $true; git push || $true
            }
          }

      - name: Align (project + function .env) + redeploy + dual-endpoint validate (5 tries)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          BRIDGE_IMPORT_TOKEN:   ${{ secrets.BRIDGE_IMPORT_TOKEN }}
          PROD_PUBLISHABLE_KEY:  ${{ secrets.PROD_PUBLISHABLE_KEY }}
          SUPABASE_URL:          ${{ secrets.PROD_SUPABASE_URL }}
        shell: pwsh
        run: |
          run: |
                    Set-StrictMode -Version Latest
                    $ErrorActionPreference="Stop"
                    $proj="${{ env.PROJECT_REF }}"
                    $fnDir="supabase/functions/import-prices"
                    $envPat=Join-Path $fnDir ".env"
                    New-Item -ItemType Directory -Force -Path $fnDir | Out-Null
                    @("BRIDGE_IMPORT_TOKEN=$env:BRIDGE_IMPORT_TOKEN") | Set-Content -Encoding UTF8 $envPat
                    supabase secrets set BRIDGE_IMPORT_TOKEN="$env:BRIDGE_IMPORT_TOKEN" --project-ref $proj
          
                    function H8([string]$s){ if(-not $s){return '<none>'}; $sha=[Security.Cryptography.SHA256]::Create(); $h=$sha.ComputeHash([Text.Encoding]::UTF8.GetBytes($s)); ([BitConverter]::ToString($h)).Replace('-','').Substring(0,8) }
                    function TryPost([string]$Url,[hashtable]$Hdr,[string]$Tag){
                      $B='{"ping":"ci-auto"}'
                      try{
                        $r=Invoke-WebRequest -Method POST -Uri $Url -Headers $Hdr -Body $B -UseBasicParsing -TimeoutSec 25
                        return @($Tag,[int]$r.StatusCode,[string]$r.Content)
                      }catch{
                        $c=try{ [int]$_.Exception.Response.StatusCode.value__ }catch{ -1 }
                        return @($Tag,$c,"")
                      }
                    }
          
                    $FN  = "https://$proj.functions.supabase.co/import-prices"
                    $PRJ = "$("${{ env.SUPABASE_URL }}".TrimEnd('/'))/functions/v1/import-prices"
                    $Hpub=@{ apikey=$env:PROD_PUBLISHABLE_KEY; 'x-bridge-token'=$env:BRIDGE_IMPORT_TOKEN; 'Content-Type'='application/json' }
                    $Hauth=$Hpub.Clone(); $Hauth['Authorization']="Bearer $($env:PROD_PUBLISHABLE_KEY)"
          
                    $finalCode=-1; $finalBody=""; $finalUrl=$FN; $finalAuth="apikey_only"; $attempts=@()
          
                    for($i=1;$i -le 5;$i++){
                      supabase functions deploy import-prices --project-ref $proj --env-file $envPat
                      Start-Sleep -Seconds 5
                      foreach($v in @(
                        @{url=$FN;  hdr=$Hpub;  tag='FN/apikey_only';  auth='apikey_only'},
                        @{url=$FN;  hdr=$Hauth; tag='FN/apikey+auth';  auth='apikey+auth'},
                        @{url=$PRJ; hdr=$Hpub;  tag='PRJ/apikey_only'; auth='apikey_only'},
                        @{url=$PRJ; hdr=$Hauth; tag='PRJ/apikey+auth'; auth='apikey+auth'}
                      )){
                        $res = TryPost $v.url $v.hdr $v.tag
                        $attempts += ('{0}:{1}' -f $res[0], $res[1])
                        if ($res[1] -ge 200 -and $res[1] -lt 300){
                          $finalCode=$res[1]; $finalBody=$res[2]; $finalUrl=$v.url; $finalAuth=$v.auth; break
                        } else { $finalCode=$res[1]; $finalBody=$res[2]; $finalUrl=$v.url; $finalAuth=$v.auth }
                      }
                      if ($finalCode -ge 200 -and $finalCode -lt 300){ break }
                      if ($i -lt 5){ Start-Sleep -Seconds 8 }
                    }
          
                    $h8 = H8 $env:BRIDGE_IMPORT_TOKEN
                    $b300= if($finalBody.Length -gt 300){ $finalBody.Substring(0,300) } else { $finalBody }
                    $six=@(
                      "URL: $finalUrl",
                      "Method: POST",
                      "Status: $finalCode",
                      "GatewayAuth: $finalAuth",
                      "BridgeTokenHash8: $h8",
                      "Body[0..300]: $b300"
                    ) -join "`n"
                    $six | Out-File sixline.txt -Encoding utf8
                    ('Attempts: ' + ($attempts -join ', ')) | Out-File attempts.txt -Encoding utf8
                    Write-Host $six
                    if($finalCode -lt 200 -or $finalCode -ge 300){ Write-Error "Auto-align failed (Status=$finalCode @ $finalUrl)" }
      - name: Upload validation summary
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: import-prices-auto-validate
          path: |
            sixline.txt
            attempts.txt
          if-no-files-found: warn

name: Auto-Align Import-Prices (bridge-only)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - .github/workflows/auto-align-import-prices.yml
      - .github/auto_align_import_prices.bump
      - supabase/functions/import-prices/**
  schedule:
    - cron: "*/30 * * * *"

concurrency:
  group: auto-align-import-prices
  cancel-in-progress: true

permissions:
  contents: write
  actions: read

env:
  PROJECT_REF: ycdxbpibncqcchqiihfz
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}

jobs:
  align-and-validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Guard required secrets
        shell: pwsh
        run: |
          if (-not "${{ secrets.SUPABASE_ACCESS_TOKEN }}") { throw "Missing SUPABASE_ACCESS_TOKEN" }
          if (-not "${{ secrets.PROD_PUBLISHABLE_KEY }}") { throw "Missing PROD_PUBLISHABLE_KEY" }
          if (-not "${{ secrets.BRIDGE_IMPORT_TOKEN }}") { throw "Missing BRIDGE_IMPORT_TOKEN" }

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1

      - name: Ensure verify_jwt=false (idempotent)
        shell: pwsh
        run: |
          $p = "supabase/functions/import-prices/config.toml"
          if (-not (Test-Path $p)) { New-Item -ItemType Directory -Force -Path (Split-Path $p) | Out-Null; Set-Content $p "verify_jwt = false" -NoNewline; git add $p; git commit -m "ci(auto): add config.toml verify_jwt=false" || $true; git push || $true }
          else {
            $txt = Get-Content $p -Raw
            if ($txt -notmatch '(?m)^\s*verify_jwt\s*=\s*false\s*$') {
              ($txt -replace '(?m)^\s*verify_jwt\s*=\s*\w+\s*$', 'verify_jwt = false') | Set-Content $p
              git add $p; git commit -m "ci(auto): enforce verify_jwt=false" || $true; git push || $true
            }
          }

      - name: Initialize proofs (latest)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'
          $ProofDir = "reports/ci_logs/latest"
          $six = Join-Path $ProofDir "sixline.txt"
          $att = Join-Path $ProofDir "attempts.txt"
          New-Item -ItemType Directory -Force -Path $ProofDir | Out-Null
          if (-not (Test-Path $six)) {
@"
ProjectRef: ycdxbpibncqcchqiihfz
Function: import-prices
GatewayAuth: (pending)
FinalCode: (pending)
FinalURL: (pending)
Timestamp: (pending)
"@ | Set-Content $six -Encoding UTF8
          }
          if (-not (Test-Path $att)) { "Attempts:" | Set-Content $att -Encoding UTF8 }

      - name: Align (project + function .env) + redeploy + dual-endpoint validate (5 tries)
        env:
          SUPABASE_ACCESS_TOKEN:      ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          BRIDGE_IMPORT_TOKEN:        ${{ secrets.BRIDGE_IMPORT_TOKEN }}
          SUPABASE_PUBLISHABLE_KEY:   ${{ secrets.PROD_PUBLISHABLE_KEY }}
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          $ProofDir = "reports/ci_logs/latest"
          $six = Join-Path $ProofDir "sixline.txt"
          $att = Join-Path $ProofDir "attempts.txt"

          New-Item -ItemType Directory -Force -Path $ProofDir | Out-Null
          if (-not (Test-Path $six)) {
@"
ProjectRef: ycdxbpibncqcchqiihfz
Function: import-prices
GatewayAuth: (pending)
FinalCode: (pending)
FinalURL: (pending)
Timestamp: (pending)
"@ | Set-Content $six -Encoding UTF8
          }
          if (-not (Test-Path $att)) { "Attempts:" | Set-Content $att -Encoding UTF8 }

          # 1) Write function .env and project secret, redeploy
          Set-Content -Path "supabase/functions/import-prices/.env" -Value @"
BRIDGE_IMPORT_TOKEN=${{ env.BRIDGE_IMPORT_TOKEN }}
"@ -Encoding UTF8

          supabase secrets set --project-ref ycdxbpibncqcchqiihfz BRIDGE_IMPORT_TOKEN=${{ env.BRIDGE_IMPORT_TOKEN }}
          supabase functions deploy import-prices --project-ref ycdxbpibncqcchqiihfz --no-verify-jwt --env-file "supabase/functions/import-prices/.env"

          $fnUrl  = "https://ycdxbpibncqcchqiihfz.functions.supabase.co/import-prices"
          $prjUrl = "${{ env.SUPABASE_URL }}/functions/v1/import-prices"
          $pub    = "${{ env.SUPABASE_PUBLISHABLE_KEY }}"

          function Try-Call {
            param([string]$Name,[string]$Url,[bool]$WithAuth)
            $h = @{ "apikey" = $pub }
            if ($WithAuth) { $h["Authorization"] = "Bearer $pub" }
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $Url -Headers $h -Body (@{health=1} | ConvertTo-Json) -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
              return [pscustomobject]@{ name=$Name; code=$resp.StatusCode; url=$Url }
            } catch {
              $code = if ($_.Exception.Response) { [int]$_.Exception.Response.StatusCode } else { -1 }
              return [pscustomobject]@{ name=$Name; code=$code; url=$Url }
            }
          }

          $final = $null
          for ($i=1; $i -le 5; $i++) {
            $tries = @(
              Try-Call "FN/apikey_only"  $fnUrl  $false
              Try-Call "FN/apikey+auth"  $fnUrl  $true
              Try-Call "PRJ/apikey_only" $prjUrl $false
              Try-Call "PRJ/apikey+auth" $prjUrl $true
            )

            # Append all tries to the single Attempts line
            $line = Get-Content $att -Raw
            $suffix = ($tries | ForEach-Object { "$($_.name):$($_.code)" }) -join ", "
            if ($line.TrimEnd() -eq "Attempts:") {
              Set-Content $att "Attempts: $suffix" -Encoding UTF8
            } else {
              Set-Content $att ($line.TrimEnd() + ", " + $suffix) -Encoding UTF8
            }

            $hit = $tries | Where-Object { $_.code -eq 200 } | Select-Object -First 1
            if ($hit) { $final = $hit; break }
          }

          # Update sixline.txt
          $sixC = Get-Content $six -Raw
          function Replace-Line($c,[string]$k,[string]$v) {
            return ($c -split "`n" | ForEach-Object { if ($_ -like "$k:*") { "$k: $v" } else { $_ } }) -join "`n"
          }
          $gw = if ($final) { $final.name } else { "(none)" }
          $code = if ($final) { "$($final.code)" } else { ($tries[-1].code) }
          $url = if ($final) { $final.url } else { $tries[-1].url }
          $stamp = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssK")

          $sixC = Replace-Line $sixC "GatewayAuth" $gw
          $sixC = Replace-Line $sixC "FinalCode"   $code
          $sixC = Replace-Line $sixC "FinalURL"    $url
          $sixC = Replace-Line $sixC "Timestamp"   $stamp
          $sixC | Set-Content $six -Encoding UTF8

          if ($code -ne "200") { exit 1 } else { exit 0 }

      - name: Upload artifacts (proofs)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: import-prices-auto-validate
          path: |
            reports/ci_logs/latest/sixline.txt
            reports/ci_logs/latest/attempts.txt
          if-no-files-found: warn

      - name: Commit proofs to repo (latest only)
        if: ${{ always() }}
        shell: pwsh
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add reports/ci_logs/latest/sixline.txt reports/ci_logs/latest/attempts.txt
          git commit -m "ci(auto): persist auto-align proofs (import-prices)" 2>$null
          git push || echo "Push skipped"
name: Auto-Align Import-Prices (bridge-only)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - .github/workflows/auto-align-import-prices.yml
      - .github/auto_align_import_prices.bump
      - supabase/functions/import-prices/**
  schedule:
    - cron: "*/30 * * * *"

concurrency:
  group: auto-align-import-prices
  cancel-in-progress: false

permissions:
  contents: write
  actions: read

env:
  PROJECT_REF: ycdxbpibncqcchqiihfz
  SUPABASE_URL: ${{ secrets.PROD_SUPABASE_URL }}
  SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PROD_PUBLISHABLE_KEY }}

jobs:
  align-and-validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Guard required secrets
        shell: pwsh
        run: |
          if (-not "${{ secrets.SUPABASE_ACCESS_TOKEN }}") { throw "Missing SUPABASE_ACCESS_TOKEN" }
          if (-not "${{ secrets.PROD_PUBLISHABLE_KEY }}") { throw "Missing PROD_PUBLISHABLE_KEY" }
          if (-not "${{ secrets.BRIDGE_IMPORT_TOKEN }}") { throw "Missing BRIDGE_IMPORT_TOKEN" }

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1

      - name: Initialize proofs
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProofDir = "reports/ci_logs/latest"
          New-Item -ItemType Directory -Force -Path $ProofDir | Out-Null
          $six = Join-Path $ProofDir "sixline.txt"
          $att = Join-Path $ProofDir "attempts.txt"
@"
ProjectRef: ycdxbpibncqcchqiihfz
Function: import-prices
GatewayAuth: (pending)
FinalCode: (pending)
FinalURL: (pending)
Timestamp: (pending)
"@ | Set-Content $six -Encoding UTF8
          "Attempts:" | Set-Content $att -Encoding UTF8

      - name: Ensure verify_jwt=false (idempotent)
        shell: pwsh
        run: |
          $p = "supabase/functions/import-prices/config.toml"
          if (-not (Test-Path $p)) { New-Item -ItemType Directory -Force -Path (Split-Path $p) | Out-Null; Set-Content $p "verify_jwt = false" -NoNewline; git add $p; git commit -m "ci(auto): add config.toml verify_jwt=false" || $true; git push || $true }
          else {
            $txt = Get-Content $p -Raw
            if ($txt -notmatch '(?m)^\s*verify_jwt\s*=\s*false\s*$') {
              ($txt -replace '(?m)^\s*verify_jwt\s*=\s*\w+\s*$', 'verify_jwt = false') | Set-Content $p
              git add $p; git commit -m "ci(auto): enforce verify_jwt=false" || $true; git push || $true
            }
          }

      - name: Install Supabase CLI (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: choco install supabase -y

      - name: Align (env) + deploy + 4-variant validate (5 tries)
        shell: pwsh
        env:
          PUB: ${{ env.SUPABASE_PUBLISHABLE_KEY }}
          PRJ: ${{ env.SUPABASE_URL }}
          BRIDGE: ${{ secrets.BRIDGE_IMPORT_TOKEN }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $ProgressPreference = "SilentlyContinue"

          $ProofDir = "reports/ci_logs/latest"
          $six = Join-Path $ProofDir "sixline.txt"
          $att = Join-Path $ProofDir "attempts.txt"

          # 1) Function .env + project secret + deploy
          Set-Content -Path "supabase/functions/import-prices/.env" -Value @"
BRIDGE_IMPORT_TOKEN=$env:BRIDGE
"@ -Encoding UTF8

          supabase secrets set --project-ref ycdxbpibncqcchqiihfz BRIDGE_IMPORT_TOKEN=$env:BRIDGE
          supabase functions deploy import-prices --project-ref ycdxbpibncqcchqiihfz --no-verify-jwt --env-file "supabase/functions/import-prices/.env"

          $fnUrl  = "https://ycdxbpibncqcchqiihfz.functions.supabase.co/import-prices"
          $prjUrl = "$env:PRJ/functions/v1/import-prices"
          $pub    = "$env:PUB"

          function Try-Call {
            param([string]$Name,[string]$Url,[bool]$WithAuth)
            $h = @{ "apikey" = $pub }
            if ($WithAuth) { $h["Authorization"] = "Bearer $pub" }
            try {
              $resp = Invoke-WebRequest -Method POST -Uri $Url -Headers $h -Body (@{health=1} | ConvertTo-Json) -ContentType 'application/json' -UseBasicParsing -TimeoutSec 20
              return [pscustomobject]@{ name=$Name; code=$resp.StatusCode; url=$Url }
            } catch {
              $code = if ($_.Exception.Response) { [int]$_.Exception.Response.StatusCode } else { -1 }
              return [pscustomobject]@{ name=$Name; code=$code; url=$Url }
            }
          }

          $final = $null
          $lastTries = $null

          for ($i=1; $i -le 5; $i++) {
            $tries = @(
              Try-Call "FN/apikey_only"  $fnUrl  $false
              Try-Call "FN/apikey+auth"  $fnUrl  $true
              Try-Call "PRJ/apikey_only" $prjUrl $false
              Try-Call "PRJ/apikey+auth" $prjUrl $true
            )
            $lastTries = $tries

            # Append all tries to the single Attempts line
            $line = Get-Content $att -Raw
            $suffix = ($tries | ForEach-Object { "$($_.name):$($_.code)" }) -join ", "
            if ($line.TrimEnd() -eq "Attempts:") {
              Set-Content $att "Attempts: $suffix" -Encoding UTF8
            } else {
              Set-Content $att ($line.TrimEnd() + ", " + $suffix) -Encoding UTF8
            }

            $hit = $tries | Where-Object { $_.code -eq 200 } | Select-Object -First 1
            if ($hit) { $final = $hit; break }
          }

          # Update sixline with result
          $sixC = Get-Content $six -Raw
          function Replace-Line($c,[string]$k,[string]$v) {
            return ($c -split "`n" | ForEach-Object { if ($_ -like "$k:*") { "$k: $v" } else { $_ } }) -join "`n"
          }
          $gw = if ($final) { $final.name } else { "(none)" }
          $code = if ($final) { "$($final.code)" } else { ($lastTries[-1].code) }
          $url = if ($final) { $final.url } else { $lastTries[-1].url }
          $stamp = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssK")

          $sixC = Replace-Line $sixC "GatewayAuth" $gw
          $sixC = Replace-Line $sixC "FinalCode"   $code
          $sixC = Replace-Line $sixC "FinalURL"    $url
          $sixC = Replace-Line $sixC "Timestamp"   $stamp
          $sixC | Set-Content $six -Encoding UTF8

          if ($code -ne "200") { exit 1 } else { exit 0 }

      - name: Upload artifacts (proofs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: import-prices-auto-validate
          path: |
            reports/ci_logs/latest/sixline.txt
            reports/ci_logs/latest/attempts.txt

      - name: Commit proofs to repo (always)
        if: always()
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          git config --global --add safe.directory "$PWD"
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add reports/ci_logs/latest/sixline.txt reports/ci_logs/latest/attempts.txt
          git commit -m "ci(auto): persist auto-align proofs (import-prices)" 2>$null
          git push
