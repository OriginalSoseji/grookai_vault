name: Kick Auto-Align (import-prices)
on:
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  kick:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Dispatch auto-align and wait
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference="Stop"

          # Anchor start time (UTC ISO)
          $anchor = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")

          # Dispatch the workflow
          gh workflow run .github/workflows/auto-align-import-prices.yml | Out-Null

          function Get-FreshRun {
            param([int]$Pages = 5)
            for($p=1; $p -le $Pages; $p++){
              $runs = gh api repos/:owner/:repo/actions/workflows/auto-align-import-prices.yml/runs --paginate -F per_page=50 -F page=$p --jq ".workflow_runs[] | {id: .id, created_at: .created_at}" 2>$null
              if(-not $runs){ continue }
              $objs = @()
              $runs -split "`n" | ForEach-Object {
                if($_.Trim().Length -gt 0){ $objs += ($_ | ConvertFrom-Json) }
              }
              $candidates = $objs | Where-Object { ([DateTime]$_.created_at) -ge ([DateTime]$anchor) } | Sort-Object { [DateTime]$_.created_at } -Descending
              if($candidates){ return $candidates[0].id }
            }
            return $null
          }

          $rid = $null
          for($i=0; $i -lt 24; $i++){
            $rid = Get-FreshRun
            if($rid){ break }
            Start-Sleep -Seconds (5 + ($i * 2))
          }
          if(-not $rid){ throw "Could not locate the newly dispatched auto-align run." }

          do{
            $o = gh api repos/:owner/:repo/actions/runs/$rid --jq "{status:.status, conclusion:.conclusion}" | ConvertFrom-Json
            if($o.status -eq "completed"){ break }
            Start-Sleep -Seconds 10
          }while($true)

      - name: Pull proofs and print summary
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference="Stop"

          git pull --rebase | Out-Null
          $six = "reports/ci_logs/latest/sixline.txt"
          $att = "reports/ci_logs/latest/attempts.txt"
          if(!(Test-Path $six) -or !(Test-Path $att)){
            throw "Proofs missing. Verify repo Settings → Actions → Workflow permissions = Read & write; YAML permissions; and always() commit."
          }
          $sixC = Get-Content $six -Raw
          $attC = Get-Content $att -Raw
          $gw = ($sixC -split "`n" | Where-Object { $_ -like "GatewayAuth:*" })[0]
          $fc = ($sixC -split "`n" | Where-Object { $_ -like "FinalCode:*" })[0]
          $al = ($attC -split "`n" | Where-Object { $_ -like "Attempts:*" })[0]
          $code = $fc -replace "[^\d]",""
          $result = if($code -eq "200"){"PASS"} else {"FAIL"}

          Write-Host "`n=== Auto-Align Proofs ==="
          Write-Host $gw
          Write-Host $fc
          Write-Host $al
          Write-Host ("Result: " + $result + " (last code = " + $code + ")")
