// Central route name constants

class RouteNames {
  static const String search = '/search';
  static const String cardDetail = '/card-detail';
  static const String devPriceImport = '/dev-price-import';
  static const String recent = '/recent';
  static const String vaultExt = '/vault-ext';
  static const String account = '/account';
  static const String devAdmin = '/dev-admin';
  static const String devHealth = '/dev-health';
  static const String devDiagPricing = '/dev/diag/pricing';
  static const String alerts = '/alerts';
  static const String scanner = '/scanner';
  static const String scanHistory = '/scan-history';
  static const String wallFeed = '/wall-feed';
  static const String wallCompose = '/wall-compose';
  static const String wallProfile = '/wall-profile';
  static const String explore = '/explore';
  static const String createListing = '/create-listing';
}
import 'package:grookai_vault/dev/dev_overlay.dart';
import 'dart:io' show Platform;
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';

import 'package:grookai_vault/ui/app/theme.dart';
import 'package:grookai_vault/ui/tokens/spacing.dart';
import 'package:grookai_vault/ui/components/profile_button.dart';
import 'package:grookai_vault/ui/app/route_names.dart';
import 'package:grookai_vault/config/flags.dart';

import 'package:grookai_vault/features/home/home_page.dart';
import 'package:grookai_vault/features/vault/vault_page.dart';
// Wishlist replaced by Profile tab in the main nav
// import 'package:grookai_vault/features/wishlist/wishlist_page.dart';
import 'package:grookai_vault/features/profile/profile_page.dart';
import 'package:grookai_vault/features/search/search_page.dart';

class AppNav extends StatefulWidget {
  const AppNav({super.key});
  @override
  State<AppNav> createState() => _AppNavState();
}

class _TabItem {
  final String label;
  final IconData icon;
  final Widget Function() builder;
  const _TabItem({
    required this.label,
    required this.icon,
    required this.builder,
  });
}

class _AppNavState extends State<AppNav> {
  // Simple tab config (Home, Search, Vault, Profile). Scan is a center action.
  late final List<_TabItem> _tabs = [
    _TabItem(label: 'Home', icon: Icons.home, builder: () => const HomePage()),
    _TabItem(
      label: 'Search',
      icon: Icons.search,
      builder: () => const SearchPage(),
    ),
    _TabItem(
      label: 'Vault',
      icon: Icons.inventory_2,
      builder: () => const VaultPage(),
    ),
    _TabItem(
      label: 'Profile',
      icon: Icons.person_outline,
      builder: () => const ProfilePage(),
    ),
  ];

  int _index = 0;

  void _openScanner() {
    if (!gvFeatureScanner) return;
    Navigator.of(context).pushNamed(RouteNames.scanner);
  }

  PreferredSizeWidget _buildMaterialAppBar(GVTheme gv) {
    // Only Profile on the right; LargeTitle not used on Material
    return AppBar(
      title: GestureDetector(
        onLongPress: () {
          // Toggle dev overlay (debug/profile only)
          DevOverlay.toggle();
        },
        child: Text(
          _tabs[_index].label,
          style: gv.typography.title.copyWith(color: gv.colors.textPrimary),
        ),
      ),
      actions: const [ProfileButton()],
    );
  }

  Widget _buildMaterial() {
    final gv = GVTheme.of(context);
    return Scaffold(
      backgroundColor: gv.colors.bg,
      appBar: _buildMaterialAppBar(gv),
      body: IndexedStack(
        index: _index,
        children: _tabs.map((t) => t.builder()).toList(),
      ),
      floatingActionButtonLocation: FloatingActionButtonLocation.centerDocked,
      floatingActionButton: gvFeatureScanner
          ? FloatingActionButton(
              onPressed: _openScanner,
              child: const Icon(Icons.camera_alt),
            )
          : null,
      bottomNavigationBar: NavigationBar(
        selectedIndex: _index,
        onDestinationSelected: (i) => setState(() => _index = i),
        destinations: [
          for (final t in _tabs)
            NavigationDestination(
              icon: Icon(_iconOutline(t.icon)),
              selectedIcon: Icon(t.icon),
              label: t.label,
            ),
        ],
      ),
    );
  }

  IconData _iconOutline(IconData filled) {
    // Provide sensible outlined variants when possible
    if (filled == Icons.home) return Icons.home_outlined;
    if (filled == Icons.inventory_2) return Icons.inventory_2_outlined;
    if (filled == Icons.person_outline) return Icons.person_outline;
    if (filled == Icons.search) return Icons.search;
    return filled;
  }

  Widget _buildCupertino() {
    final gv = GVTheme.of(context);
    // Cupertino: 5 items with center placeholder; middle scan as floating action
    return CupertinoTabScaffold(
      tabBar: CupertinoTabBar(
        items: const [
          BottomNavigationBarItem(
            icon: Icon(CupertinoIcons.house),
            label: 'Home',
          ),
          BottomNavigationBarItem(
            icon: Icon(CupertinoIcons.search),
            label: 'Search',
          ),
          // Center placeholder
          BottomNavigationBarItem(
            icon: Icon(CupertinoIcons.camera_viewfinder),
            label: '',
          ),
          BottomNavigationBarItem(
            icon: Icon(CupertinoIcons.cube_box),
            label: 'Vault',
          ),
          BottomNavigationBarItem(
            icon: Icon(CupertinoIcons.person),
            label: 'Profile',
          ),
        ],
      ),
      tabBuilder: (context, index) {
        final mapped = index < 2 ? index : (index == 2 ? -1 : index - 1);
        if (mapped == -1) {
          // Center slot is handled by the floating pill
          return const SizedBox.shrink();
        }
        final tab = _tabs[mapped];
        return CupertinoPageScaffold(
          navigationBar: CupertinoNavigationBar(
            middle: Text(tab.label, style: gv.typography.title),
            trailing: const ProfileButton(),
          ),
          child: SafeArea(
            top: false,
            child: Stack(
              children: [
                // Tab content
                Positioned.fill(child: tab.builder()),
                // Center scan affordance overlayed above tab bar
                if (gvFeatureScanner)
                  Positioned(
                    bottom: 8,
                    left: 0,
                    right: 0,
                    child: Center(
                      child: GestureDetector(
                        onTap: _openScanner,
                        child: DecoratedBox(
                          decoration: BoxDecoration(
                            color: Theme.of(context).colorScheme.primary,
                            borderRadius: BorderRadius.circular(28),
                          ),
                          child: Padding(
                            padding: EdgeInsets.symmetric(
                              horizontal: GVSpacing.s16,
                              vertical: GVSpacing.s12,
                            ),
                            child: Row(
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                Icon(
                                  CupertinoIcons.camera,
                                  color: Theme.of(context).colorScheme.onPrimary,
                                ),
                                SizedBox(width: GVSpacing.s8),
                                Text(
                                  'Scan',
                                  style: TextStyle(
                                    color: Theme.of(context).colorScheme.onPrimary,
                                    fontWeight: FontWeight.w700,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ),
                      ),
                    ),
                  ),
              ],
            ),
          ),
        );
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    final isIOS =
        Theme.of(context).platform == TargetPlatform.iOS || Platform.isIOS;
