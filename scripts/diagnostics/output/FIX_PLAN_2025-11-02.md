# Fix Plan — Nov 2, 2025

Owner: Cesar  
Estimates: S (≤2h), M (≤1d), L (>1d)

## P1 — Data correctness, auth, crashers (today/tomorrow)

- Ensure client can read pricing health safely (S)
  - Option A: grant anon read to `pricing_health_v`.
    - Edit: `supabase/migrations/20251102_220843_pricing_refresh_security.sql` (or add a new grant-only migration) to `grant select on public.pricing_health_v to anon, authenticated;`
  - Option B: expose narrow RPC `pricing_health_get()` and call that from the app; revoke anon select on the view.
    - Files: `supabase/migrations/<new>_pricing_health_rpc.sql`, `lib/services/pricing_health_service.dart`
- Verify Edge env for pricing refresh/import (S)
  - Confirm the following secrets exist in prod/stage projects (Edge Functions): `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY` (or `SERVICE_ROLE_KEY`), and `POKEMON_TCG_API_KEY`.
  - Files: `supabase/functions/pricing_refresh/index.ts`, `supabase/functions/import-prices/index.ts`
  - Add an example doc: `supabase/functions/_shared/.env.example` listing required keys (S)
- Harden job visibility (S)
  - Double-check no grants to anon/auth on tables `public.jobs`, `public.job_logs` in production (already revoked in migration). Validate PostgREST anon/auth can’t select.
  - Files: `supabase/migrations/20251102_220843_pricing_refresh_security.sql`
- Replace broad `.select('*')` in hot paths (S)
  - Files:
    - `lib/features/dev/diagnostics/pricing_probe_page.dart:58` → select only `card_id, condition, observed_at, price_mid`.
    - `lib/services/vault_service.dart:91` → project required columns only.
- Add fetch timeouts to long-running Edge calls (S)
  - Wrap external `fetch` in `AbortController` with 10–20s timeout.
  - Files: `supabase/functions/import-prices/index.ts`, `supabase/functions/system_health/index.ts`, `supabase/functions/prices_status/index.ts`

## P2 — Performance, polish, compatibility (this week)

- Indices validation for price lookups (M)
  - Ensure indices on `(card_id, condition_label)` where applicable, and FK paths used by `wall_feed_v`.
  - Files: `scripts/supabase/migrations/B_latest_card_prices_mv.sql` (if adding), new migration under `supabase/migrations/`.
- Wall feed payload hygiene (M)
  - Ensure `wall_feed_v` projects minimal columns; add thumbnail/preview URL if large images are shipped.
  - Files: `supabase/migrations/20251103_120000_public_wall_mvp.sql`
- Diagnostics automation (S)
  - Add VS Code task to run the diagnostic bundle and persist under `scripts/diagnostics/output/`.
  - Files: `.vscode/tasks.json`
- Edge retries/backoff (M)
  - Add limited retries (e.g., 2) with exponential backoff to external calls (PTCG/eBay/JustTCG) to reduce flake.
  - Files: `supabase/functions/*/index.ts`

## P3 — Refactors, DX, non-blocking UI (next)

- Shared accent/glow components (M)
  - Introduce `GlowChip`, `GlowButton`, and update diagnostics pages to consume them.
  - Files: `lib/ui/widgets/glow_chip.dart`, `lib/ui/widgets/glow_button.dart`, usages across `lib/features/**`
- Dart cleanup (S)
  - Run `dart fix --apply` and address lints incrementally.
- Unit tests for pricing health cache (S)
  - Verify 5‑minute cache hit path; add expiry test.
  - Files: `test/services/pricing_health_service_test.dart`

## Exact Commands

```powershell
# P1: grant anon access to pricing_health_v (if chosen)
Add-Content supabase\migrations\20251104_grants_pricing_health.sql "grant select on public.pricing_health_v to anon, authenticated;"

# Diagnostics bundle
mkdir -Force scripts\diagnostics\output | Out-Null
flutter analyze > scripts\diagnostics\output\flutter_analyze.txt 2>&1
supabase db lint > scripts\diagnostics\output\supabase_db_lint.txt 2>&1
pwsh -File scripts\tools\scan_schema_compat.ps1 -Verbose *> scripts\diagnostics\output\scan_schema_compat_verbose.txt
```

